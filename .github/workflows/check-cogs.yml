name: "Check Cogs"

on:
  pull_request:


jobs:
  test-cogs:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Red-DiscordBot
        run: pip install red-discordbot typing_extensions==4.10.0

      - name: Test Cogs
        uses: nntin/d-flows/actions/test-red-discordbot-downloader@v1
        with:
          token: ${{ secrets.DISCORD_BOT_TOKEN }}
          repo_url: https://github.com/${{ github.repository }}
          repo_branch: ${{ github.head_ref || github.ref_name }}

  ##################################################################
  ####     Build validation results for Discord notification    ####
  ##################################################################
  build-validation-fields:
    name: Build Validation Fields
    runs-on: ubuntu-latest
    needs: [test-cogs]
    if: always()
    outputs:
      discord_fields: ${{ steps.discord_fields.outputs.fields }}
      validation_result: ${{ steps.validation_result.outputs.result }}

    steps:
      - name: Determine validation result
        id: validation_result
        run: |
          TEST_STATUS="${{ needs['test-cogs'].result }}"
          echo "result=${TEST_STATUS}" >> "$GITHUB_OUTPUT"

      - name: Build Discord Fields
        id: discord_fields
        run: |
          TEST_STATUS="${{ needs['test-cogs'].result }}"

          TEST_EMOJI=$([[ "$TEST_STATUS" == "success" ]] && echo "✅" || echo "❌")

          FIELDS=$(jq -n \
            --arg test_status "$TEST_EMOJI $TEST_STATUS" \
            --arg actor "${{ github.actor }}" \
            --arg pr_number "${{ github.event.pull_request.number }}" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[
              {"name": "Cog Tests", "value": $test_status, "inline": true},
              {"name": "PR Details", "value": ("[#" + $pr_number + "](" + $pr_url + ") by @" + $actor), "inline": false},
              {"name": "Run Details", "value": ("[View Full Run](" + $run_url + ")"), "inline": false}
            ]')

          delimiter="$(openssl rand -hex 8)"
          {
            echo "fields<<${delimiter}"
            echo "$FIELDS"
            echo "${delimiter}"
          } >> "$GITHUB_OUTPUT"

  ##################################################################
  ####       Display validation results via Step Summary        ####
  ##################################################################
  display-validation-summary:
    name: Display Validation Summary
    runs-on: ubuntu-latest
    needs: [test-cogs, build-validation-fields]
    if: always()

    steps:
      - name: Write Step Summary
        uses: nntin/d-flows/actions/step-summary@v1
        with:
          title: 'Cog Validation Results'
          markdown: |
            | Stage | Status |
            |-------|--------|
            | Cog Tests | ${{ needs['test-cogs'].result == 'success' && '✅ Passed' || '❌ Failed' }} |
          overwrite: false

  # requires: secrets.DISCORD_WEBHOOK_URL to be set in the repository
  ##################################################################
  ####         Display validation results via Discord           ####
  ##################################################################
  # notify-cog-validation:
  #   name: Notify Validation Results
  #   runs-on: ubuntu-latest
  #   needs: [build-validation-fields, display-validation-summary]
  #   if: always()

  #   steps:
  #     - name: Send Discord Notification
  #       uses: nntin/d-flows/actions/discord-notify@v1
  #       with:
  #         webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
  #         message_type: 'embed'
  #         color: ${{ needs.build-validation-fields.outputs.validation_result == 'success' && '3066993' || '16776960' }}
  #         fields: ${{ needs.build-validation-fields.outputs.discord_fields }}